# MRS 物料收发管理系统需求规格说明书 (v3.0)
**—— 基于“外部赋码”与“包裹台账”的纯粹库存管理系统**

**版本**: v3.0 (Pure Ledger Edition)
**日期**: 2025-12-01
**项目性质**: **全新设计与开发 (Rewrite)**
**核心定义**: MRS 是一个**“数字化账本”**。它不生产标签，而是接收上游系统（Express）已经处理好的包裹信息，负责记录其从“入库”到“出库”的全生命周期状态，并提供多维度的统计报表。

---

## 1. 系统边界与核心哲学

### 1.1 职责划分 (System Boundary)
* **上游 (Express 系统)**:
    * **负责实物处理**: 包裹清点、批次生成、箱号分配。
    * **负责标签输出**: 打印物理标签（含：品名、批次号、箱号、二维码/条形码）。
* **本系统 (MRS 系统)**:
    * **负责数字化登记**: 依据实物标签信息，在系统中建立对应的库存台账。
    * **负责状态管理**: 标记每一个包裹是“在库”、“已出库”还是“损耗”。
    * **负责数据统计**: 提供月度收发报表和实时库存清单。

### 1.2 核心设计哲学：包裹即商品 (Package as Item)
* **原子单位**: 系统管理的最小颗粒度是 **“一个包裹”**。无论这个包裹里有多少个散件，对于 MRS 而言，它就是一个独立的库存实体。
* **三要素定位法**: 在不使用扫码枪的环境下，操作员通过物理标签上的三个视觉要素来锁定库存：
    1.  **货 (Product)**: 包裹里是什么？（例：香蕉）
    2.  **批 (Batch)**: 哪一批进来的？（例：A01）
    3.  **号 (Number)**: 第几个包裹？（例：0001）

---

## 2. 详细用户场景 (User Scenarios)

### 场景一：入库登记 (Inbound Registration)
> **目标**: 将仓库中已贴好 Express 标签的包裹录入 MRS 系统，建立库存。

* **前置条件**: 仓库收到 5 个包裹，标签显示：`香蕉 | 批次:A01 | 编号:0001` 至 `0005`。
* **步骤 1: 录入 (Entry)**
    * 用户在【入库录入】界面，输入标签上的可见信息：
        * **物料**: 选择 `香蕉` (支持首字母搜索)。
        * **批次**: 输入 `A01` (手工输入，或选择今日常用批次)。
        * **箱号范围**: 输入 `1-5` (系统自动理解为 0001, 0002, 0003, 0004, 0005)。
        * **单箱规格**: 输入 `20` (斤/个，仅作为参考数据记录，不参与复杂计算)。
* **步骤 2: 建账 (Ledger Creation)**
    * 系统在数据库生成 5 条独立记录。
    * **状态**: `in_stock` (在库)。
    * **时间**: 记录当前时间为 `inbound_time`。

### 场景二：出库核销 (Outbound Processing)
> **目标**: 准确扣减特定包裹的库存，确保“账实相符”。

* **步骤 1: 需求 (Request)**
    * 用户创建出库任务，选择物料 `香蕉`，需求 `2箱`。
* **步骤 2: 选箱 (Selection)** —— *核心交互*
    * 系统弹出【选箱窗口】，列出当前库存中所有可用的香蕉包裹（按入库时间 FIFO 排序）：
        * `[ ] A01 - 0001 (20斤) | 入库: 12-01`
        * `[ ] A01 - 0002 (20斤) | 入库: 12-01`
        * `[ ] B05 - 0001 (20斤) | 入库: 11-20`
    * **操作员动作**: 看一眼手里的实物标签，确认拿走的是 A01 批次的 0001 和 0002 号。
    * 在界面上**勾选**这两行。
* **步骤 3: 确认 (Confirm)**
    * 点击【确认出库】。
    * 系统将这两条记录的状态更新为 `shipped` (已出库)。
    * **时间**: 记录当前时间为 `outbound_time`。

### 场景三：库存盘点与修正 (Audit & Adjustment)
> **目标**: 处理包裹损坏或标签错误。

* **背景**: 发现 `A01` 批次的 `0003` 号包裹实际已经损坏。
* **操作**:
    1.  在库存列表中找到 `A01 - 0003`。
    2.  点击【状态变更】 -> 选择 `void` (损耗/作废)。
    3.  系统记录损耗原因，该包裹不再计入可用库存。

---

## 3. 统计报表需求 (Statistics & Reporting)

系统必须提供精准的数据统计功能，这是 MRS 作为“账本”的核心价值。

### 3.1 月度流量统计 (Monthly Flow)
* **入库统计**:
    * 查询维度：按月份（如 2025-11）。
    * 展示内容：本月共入库多少个包裹，涉及多少种物料。
    * *计算逻辑*: `COUNT(id) WHERE inbound_time IN [Month]`。
* **出库统计**:
    * 查询维度：按月份。
    * 展示内容：本月共发出多少个包裹。
    * *计算逻辑*: `COUNT(id) WHERE outbound_time IN [Month] AND status='shipped'`。

### 3.2 实时库存快照 (Current Inventory)
* **目标**: 回答“我现在库里还有什么？”
* **展示形式**:
    * **汇总视图**:
        * 香蕉：10 箱
        * 苹果：5 箱
    * **明细视图** (点击物料展开):
        * 香蕉:
            * `A01-0004` (在库, 20天)
            * `A01-0005` (在库, 20天)
            * `B02-0001` (在库, 2天)

---

## 4. 数据库设计 (Database Schema)

核心围绕一张扁平化的**包裹台账表**展开。

### 4.1 核心表：`mrs_package_ledger` (包裹台账)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `package_id` | PK (BigInt) | 系统唯一ID (自增) |
| `sku_name` | Varchar | **货**: 物料名称 (直接存名称或关联SKU表) |
| `batch_code` | Varchar | **批**: 批次号 (如 "A01") |
| `box_number` | Varchar | **号**: 箱号 (如 "0001") |
| `spec_info` | Varchar | 规格备注 (如 "20斤", "500个", 仅展示用) |
| `status` | Enum | 状态: `in_stock`(在库), `shipped`(已出), `void`(损耗) |
| `inbound_time` | DateTime | 入库时间 (用于月度入库统计) |
| `outbound_time` | DateTime | 出库时间 (用于月度出库统计) |
| `created_at` | DateTime | 记录创建时间 |

* **索引**:
    * `idx_status`: 用于快速查询库存。
    * `idx_inbound_time`: 用于入库报表。
    * `idx_outbound_time`: 用于出库报表。
    * `idx_sku_batch_box`: 联合索引，防止重复录入。

### 4.2 辅助表
* `mrs_sku`: 仅存储常用物料名称，用于输入联想（Autocomplete）。

---

## 5. 开发实施原则

1.  **极简录入**: 入库界面必须支持“批量生成箱号”（例如输入 1-10 自动生成 10 行），避免人工逐行输入。
2.  **信任原则**: MRS 默认信任用户输入的批次号和箱号是正确的，不进行复杂的规则校验（如批次号格式验证），以最大化兼容 Express 系统的变化。
3.  **数据不可变**: 包裹一旦出库（status='shipped'），其入库记录不得被修改或删除，只能通过“退货入库”产生新记录，以保证账目可追溯。